<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Gateway ‚Äî Test Suite</title>
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141416;
      --bg-tertiary: #1c1c1f;
      --bg-card: #18181b;
      --text-primary: #f4f4f5;
      --text-secondary: #a1a1aa;
      --text-muted: #52525b;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-dim: rgba(59,130,246,0.12);
      --success: #22c55e;
      --success-dim: rgba(34,197,94,0.12);
      --error: #ef4444;
      --error-dim: rgba(239,68,68,0.12);
      --warning: #f59e0b;
      --warning-dim: rgba(245,158,11,0.12);
      --purple: #a855f7;
      --purple-dim: rgba(168,85,247,0.12);
      --border: #27272a;
      --border-light: #3f3f46;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;min-height:100vh}

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .app{display:grid;grid-template-columns:240px 1fr;grid-template-rows:56px 1fr;min-height:100vh}
    .topbar{grid-column:1/-1;display:flex;align-items:center;gap:16px;padding:0 24px;background:var(--bg-secondary);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .topbar-logo{font-size:0.95rem;font-weight:700;letter-spacing:-0.3px;color:var(--text-primary)}
    .topbar-logo span{color:var(--accent)}
    .topbar-env{display:flex;align-items:center;gap:8px;margin-left:auto}
    .topbar-env select,.topbar-env input{padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.8rem}
    .topbar-env input{min-width:220px}
    .sidebar{background:var(--bg-secondary);border-right:1px solid var(--border);padding:16px 0;overflow-y:auto}
    .sidebar-section{padding:0 12px;margin-bottom:4px}
    .sidebar-label{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:8px 8px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:7px;cursor:pointer;font-size:0.85rem;color:var(--text-secondary);transition:all 0.15s;border:none;background:none;width:100%;text-align:left}
    .nav-item:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .nav-item.active{background:var(--accent-dim);color:var(--accent);font-weight:500}
    .nav-item .icon{font-size:1rem;width:20px;text-align:center;flex-shrink:0}
    .nav-badge{margin-left:auto;font-size:0.65rem;padding:2px 6px;border-radius:10px;background:var(--bg-tertiary);color:var(--text-muted)}
    .nav-item.active .nav-badge{background:var(--accent-dim);color:var(--accent)}
    .main{overflow-y:auto;padding:24px}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
    .card-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .card-header h2{font-size:1rem;font-weight:600;flex:1}
    .step-num{width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;border-radius:50%;font-size:0.8rem;font-weight:700;flex-shrink:0}
    .step-num.done{background:var(--success)}
    .step-num.fail{background:var(--error)}

    /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
    .form-group{margin-bottom:14px}
    .form-group label{display:block;font-size:0.72rem;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:0.5px;font-weight:500}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:7px;color:var(--text-primary);font-size:0.875rem;transition:border-color 0.15s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border:none;border-radius:7px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 0.15s;white-space:nowrap}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{background:#16a34a}
    .btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}
    .btn-secondary:hover{border-color:var(--border-light);background:var(--bg-secondary)}
    .btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
    .btn-ghost:hover{color:var(--text-primary);border-color:var(--border-light)}
    .btn-danger{background:var(--error-dim);color:var(--error);border:1px solid rgba(239,68,68,0.2)}
    .btn-danger:hover{background:var(--error);color:#fff}
    .btn-full{width:100%}
    .btn:disabled{opacity:0.4;cursor:not-allowed}
    .btn-sm{padding:5px 12px;font-size:0.78rem}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}

    /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:0.72rem;font-weight:500}
    .badge-success{background:var(--success-dim);color:var(--success)}
    .badge-error{background:var(--error-dim);color:var(--error)}
    .badge-warning{background:var(--warning-dim);color:var(--warning)}
    .badge-info{background:var(--accent-dim);color:var(--accent)}
    .badge-purple{background:var(--purple-dim);color:var(--purple)}

    /* ‚îÄ‚îÄ Code / Info Boxes ‚îÄ‚îÄ */
    .code-box{background:var(--bg-tertiary);border-radius:8px;padding:14px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:0.78rem;overflow-x:auto;position:relative;border:1px solid var(--border)}
    .code-box pre{white-space:pre-wrap;word-break:break-all;color:var(--text-primary);margin:0}
    .code-box .copy-btn{position:absolute;top:8px;right:8px}
    .result-box{border-radius:8px;padding:14px;margin-top:12px;border-left:3px solid var(--border);background:var(--bg-tertiary);font-family:'SF Mono',Monaco,Consolas,monospace;font-size:0.78rem}
    .result-box.ok{border-color:var(--success);background:var(--success-dim)}
    .result-box.err{border-color:var(--error);background:var(--error-dim)}
    .result-box.warn{border-color:var(--warning);background:var(--warning-dim)}
    .result-box pre{white-space:pre-wrap;word-break:break-all;margin:0}
    .result-label{font-size:0.7rem;color:var(--text-secondary);margin-bottom:6px;font-family:inherit;text-transform:uppercase;letter-spacing:0.5px}
    .hidden{display:none!important}

    /* ‚îÄ‚îÄ Token Display ‚îÄ‚îÄ */
    .token-field{margin-bottom:12px}
    .token-value{display:flex;align-items:flex-start;gap:8px}
    .token-value textarea{flex:1;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:monospace;font-size:0.72rem;resize:none}

    /* ‚îÄ‚îÄ JWT Decoder ‚îÄ‚îÄ */
    .jwt-section{margin-top:8px}
    .jwt-part{margin-bottom:12px}
    .jwt-part-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px}
    .jwt-payload-field{display:flex;align-items:baseline;gap:8px;padding:3px 0;border-bottom:1px solid var(--border);font-size:0.8rem}
    .jwt-payload-field:last-child{border:none}
    .jwt-key{color:var(--accent);font-family:monospace;min-width:140px;flex-shrink:0;font-size:0.75rem}
    .jwt-val{color:var(--text-primary);word-break:break-all;font-family:monospace;font-size:0.75rem}
    .jwt-val.uai{color:var(--purple);font-weight:600}
    .jwt-val.exp-ok{color:var(--success)}
    .jwt-val.exp-warn{color:var(--warning)}
    .jwt-val.exp-bad{color:var(--error)}

    /* ‚îÄ‚îÄ User Card ‚îÄ‚îÄ */
    .user-card{display:flex;align-items:center;gap:14px;padding:14px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:14px}
    .user-avatar{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--purple));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;flex-shrink:0}
    .user-meta h3{font-size:0.95rem;font-weight:600;margin-bottom:2px}
    .user-meta p{color:var(--text-secondary);font-size:0.8rem}
    .user-meta .uai-badge{font-family:monospace;font-size:0.7rem;color:var(--purple);background:var(--purple-dim);padding:2px 6px;border-radius:4px;display:inline-block;margin-top:2px}

    /* ‚îÄ‚îÄ Flow Diagram ‚îÄ‚îÄ */
    .flow{display:flex;align-items:center;gap:6px;padding:14px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;flex-wrap:wrap;justify-content:center}
    .flow-node{padding:6px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;font-size:0.75rem;text-align:center;transition:all 0.2s}
    .flow-node.active{border-color:var(--accent);background:var(--accent-dim);color:var(--accent)}
    .flow-node.done{border-color:var(--success);background:var(--success-dim);color:var(--success)}
    .flow-arrow{color:var(--text-muted);font-size:0.9rem}

    /* ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ */
    .log-panel{background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;max-height:260px;overflow-y:auto;font-family:monospace;font-size:0.75rem}
    .log-row{display:flex;gap:10px;padding:6px 12px;border-bottom:1px solid rgba(255,255,255,0.03);align-items:baseline}
    .log-row:last-child{border:none}
    .log-t{color:var(--text-muted);flex-shrink:0;font-size:0.68rem}
    .log-method{flex-shrink:0;font-weight:600;min-width:44px}
    .log-ok{color:var(--success)}
    .log-err{color:var(--error)}
    .log-warn{color:var(--warning)}
    .log-inf{color:var(--accent)}
    .log-url{color:var(--text-secondary);flex:1;word-break:break-all}
    .log-status{flex-shrink:0;font-size:0.68rem;padding:1px 6px;border-radius:4px}
    .log-status.s2xx{background:var(--success-dim);color:var(--success)}
    .log-status.s4xx{background:var(--error-dim);color:var(--error)}
    .log-status.s5xx{background:var(--warning-dim);color:var(--warning)}
    .log-ms{color:var(--text-muted);font-size:0.68rem;flex-shrink:0}

    /* ‚îÄ‚îÄ Health Grid ‚îÄ‚îÄ */
    .health-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:8px}
    .health-item{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center}
    .health-item .val{font-size:1.3rem;font-weight:700;margin:4px 0}
    .health-item .lbl{font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px}

    /* ‚îÄ‚îÄ Countdown ‚îÄ‚îÄ */
    .expiry-bar{height:4px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden}
    .expiry-fill{height:100%;border-radius:2px;transition:width 1s linear,background 1s linear}

    /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
    .section-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin:20px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}.app{grid-template-columns:1fr}.sidebar{display:none}}
    @media(max-width:640px){.form-row,.form-row-3{grid-template-columns:1fr}}

    /* ‚îÄ‚îÄ Password show/hide ‚îÄ‚îÄ */
    .pw-wrap{position:relative}
    .pw-wrap input{padding-right:40px}
    .pw-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1rem;padding:0}
  </style>
</head>
<body>
<div class="app">

  <!-- Top Bar -->
  <header class="topbar">
    <div class="topbar-logo">Auth<span>Gateway</span> <span style="color:var(--text-muted);font-weight:400;font-size:0.8rem">/ Test Suite</span></div>
    <div class="topbar-env">
      <select id="envSelect" onchange="onEnvChange()">
        <option value="local">Local :4000</option>
        <option value="staging">Staging</option>
        <option value="production" selected>Production</option>
      </select>
      <input type="text" id="baseUrlInput" value="https://auth.lanonasis.com" oninput="checkHealth()" />
      <span class="badge" id="healthBadge">‚óè&nbsp;Checking</span>
    </div>
  </header>

  <!-- Sidebar Nav -->
  <nav class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Auth Flows</div>
      <button class="nav-item active" onclick="showTab('pkce',this)">
        <span class="icon">üîê</span> OAuth 2.0 PKCE
        <span class="nav-badge" id="pkce-badge">4 steps</span>
      </button>
      <button class="nav-item" onclick="showTab('password',this)">
        <span class="icon">üîë</span> Password Login
        <span class="nav-badge">direct</span>
      </button>
      <button class="nav-item" onclick="showTab('otp',this)">
        <span class="icon">üìß</span> OTP / Magic Link
        <span class="nav-badge">passwordless</span>
      </button>
      <button class="nav-item" onclick="showTab('apikey',this)">
        <span class="icon">üóùÔ∏è</span> API Key
        <span class="nav-badge">lano_</span>
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Inspect</div>
      <button class="nav-item" onclick="showTab('inspector',this)">
        <span class="icon">üîç</span> Token Inspector
      </button>
      <button class="nav-item" onclick="showTab('whoami',this)">
        <span class="icon">üë§</span> Whoami / Profile
      </button>
      <button class="nav-item" onclick="showTab('endpoints',this)">
        <span class="icon">üì°</span> Endpoint Tester
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">System</div>
      <button class="nav-item" onclick="showTab('health',this)">
        <span class="icon">üíö</span> Health &amp; Status
      </button>
      <button class="nav-item" onclick="showTab('log',this)">
        <span class="icon">üìã</span> Request Log
        <span class="nav-badge" id="log-count">0</span>
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">

    <!-- ====== TAB: OAuth PKCE ====== -->
    <div class="tab-panel active" id="tab-pkce">
      <div class="flow" id="pkce-flow">
        <div class="flow-node" id="fn-client">Register</div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="fn-pkce">PKCE</div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="fn-auth">/authorize</div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="fn-login">Login</div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="fn-callback">Callback</div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="fn-exchange">Token</div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="fn-done">‚úì Authed</div>
      </div>

      <!-- Pre-auth -->
      <div id="pkce-preauth">
        <!-- Step 1 -->
        <div class="card">
          <div class="card-header">
            <div class="step-num" id="s1">1</div>
            <h2>Register OAuth Client <span style="color:var(--text-muted);font-weight:400;font-size:0.8rem">RFC 7591 Dynamic Registration</span></h2>
          </div>
          <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Dynamically registers a client ‚Äî exactly what CLI &amp; IDE tools do on first run.</p>
          <div class="form-row">
            <div class="form-group">
              <label>Client Name</label>
              <input type="text" id="clientName" value="E2E Test Client" />
            </div>
            <div class="form-group">
              <label>Scopes</label>
              <input type="text" id="scopes" value="memories:read memories:write mcp:connect" />
            </div>
          </div>
          <div class="form-group">
            <label>Redirect URI <span style="color:var(--text-muted)">(auto-set to this page)</span></label>
            <input type="text" id="redirectUri" readonly />
          </div>
          <button class="btn btn-primary btn-full" id="registerBtn" onclick="registerClient()">Register Client</button>
          <div class="result-box hidden" id="r-register"></div>
        </div>

        <!-- Step 2 -->
        <div class="card">
          <div class="card-header">
            <div class="step-num" id="s2">2</div>
            <h2>Generate PKCE Challenge <span style="color:var(--text-muted);font-weight:400;font-size:0.8rem">S256</span></h2>
          </div>
          <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Creates <code style="color:var(--accent)">code_verifier</code> (stored locally) and <code style="color:var(--accent)">code_challenge</code> (sent to server).</p>
          <button class="btn btn-primary btn-full" id="pkceBtn" onclick="generatePKCE()" disabled>Generate PKCE</button>
          <div class="code-box hidden" id="pkce-display" style="margin-top:12px">
            <div style="margin-bottom:10px">
              <div class="result-label">code_verifier <span style="color:var(--warning)">(secret ‚Äî stored in sessionStorage)</span></div>
              <div id="cvDisplay" style="word-break:break-all;color:var(--warning);font-size:0.75rem"></div>
            </div>
            <div>
              <div class="result-label">code_challenge <span style="color:var(--success)">(sent in authorization request)</span></div>
              <div id="ccDisplay" style="word-break:break-all;color:var(--success);font-size:0.75rem"></div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="card">
          <div class="card-header">
            <div class="step-num" id="s3">3</div>
            <h2>Start Authorization</h2>
          </div>
          <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Redirects to <code style="color:var(--accent)">/oauth/authorize</code> ‚Äî you'll see the real login page.</p>
          <div class="code-box" id="authUrlBox" style="margin-bottom:12px">
            <div class="result-label">Authorization URL</div>
            <div id="authUrlDisplay" style="color:var(--text-secondary);font-size:0.75rem;word-break:break-all">Generate PKCE first‚Ä¶</div>
          </div>
          <button class="btn btn-primary btn-full" id="startAuthBtn" onclick="startOAuthFlow()" disabled>Open Authorization Page ‚Üí</button>
        </div>
      </div>

      <!-- Callback processing -->
      <div id="pkce-callback" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="step-num" id="s4">4</div>
            <h2>Callback ‚Äî Exchanging Code for Tokens</h2>
          </div>
          <div class="code-box" id="callbackBox">
            <div class="result-label">Authorization Code</div>
            <div id="authCodeDisplay" style="word-break:break-all;color:var(--success)"></div>
            <div class="result-label" style="margin-top:8px">State</div>
            <div id="stateDisplay" style="word-break:break-all;color:var(--text-secondary)"></div>
          </div>
          <div class="result-box" id="exchangeResult" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- Authenticated state -->
      <div id="pkce-authed" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="step-num done">‚úì</div>
            <h2>Authenticated via OAuth PKCE</h2>
            <span class="badge badge-success">Active session</span>
          </div>
          <div class="user-card" id="pkce-user-card">
            <div class="user-avatar" id="pkce-avatar">?</div>
            <div class="user-meta">
              <h3 id="pkce-email">‚Äî</h3>
              <p id="pkce-role">Role: ‚Äî</p>
              <div class="uai-badge hidden" id="pkce-uai"></div>
            </div>
            <div style="margin-left:auto;text-align:right">
              <div style="font-size:0.75rem;color:var(--text-muted)">Expires in</div>
              <div id="pkce-expiry" style="font-size:1.1rem;font-weight:700;color:var(--success)">‚Äî</div>
              <div class="expiry-bar"><div class="expiry-fill" id="pkce-expiry-fill" style="width:100%;background:var(--success)"></div></div>
            </div>
          </div>

          <div class="token-field">
            <div class="result-label">Access Token</div>
            <div class="token-value">
              <textarea id="pkce-access-token" readonly rows="3"></textarea>
              <button class="btn btn-ghost btn-sm" onclick="copyText('pkce-access-token')">Copy</button>
            </div>
          </div>
          <div class="token-field">
            <div class="result-label">Refresh Token</div>
            <div class="token-value">
              <textarea id="pkce-refresh-token" readonly rows="2"></textarea>
              <button class="btn btn-ghost btn-sm" onclick="copyText('pkce-refresh-token')">Copy</button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="whoami()">üë§ Whoami</button>
            <button class="btn btn-secondary" onclick="verifyToken()">‚úì Verify</button>
            <button class="btn btn-secondary" onclick="getSession()">üîó Session</button>
            <button class="btn btn-secondary" onclick="introspectToken()">üî¨ Introspect</button>
            <button class="btn btn-secondary" onclick="refreshAccessToken()">‚ôªÔ∏è Refresh Token</button>
            <button class="btn btn-danger" onclick="logoutOAuth()">Logout</button>
          </div>
          <div class="result-box hidden" id="pkce-action-result" style="margin-top:12px"></div>
        </div>

        <div class="card">
          <button class="btn btn-ghost btn-full" onclick="resetPkce()">‚Ü∫ Reset &amp; Start New Flow</button>
        </div>
      </div>

      <!-- Error state -->
      <div id="pkce-error" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="step-num fail">‚úó</div>
            <h2>Authorization Failed</h2>
          </div>
          <div class="result-box err" id="pkce-error-box"></div>
          <button class="btn btn-primary btn-full" onclick="resetPkce()" style="margin-top:14px">Try Again</button>
        </div>
      </div>
    </div>

    <!-- ====== TAB: Password Login ====== -->
    <div class="tab-panel" id="tab-password">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üîë</span>
          <h2>Password / Credentials Login</h2>
          <span class="badge badge-info">POST /v1/auth/login</span>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Direct email/password authentication. Returns gateway JWT with UAI embedded.</p>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="pw-email" placeholder="user@example.com" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="pw-wrap">
            <input type="password" id="pw-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <button class="pw-toggle" onclick="togglePw('pw-pass',this)">üëÅ</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Platform</label>
            <select id="pw-platform">
              <option value="web">web</option>
              <option value="cli" selected>cli</option>
              <option value="api">api</option>
              <option value="mcp">mcp</option>
            </select>
          </div>
          <div class="form-group">
            <label>Project Scope (optional)</label>
            <input type="text" id="pw-scope" placeholder="lanonasis-maas" />
          </div>
        </div>
        <button class="btn btn-primary btn-full" onclick="passwordLogin()">Login with Password</button>
        <div class="result-box hidden" id="pw-result"></div>

        <div id="pw-authed" class="hidden" style="margin-top:16px">
          <div class="user-card">
            <div class="user-avatar" id="pw-avatar">?</div>
            <div class="user-meta">
              <h3 id="pw-email-display">‚Äî</h3>
              <p id="pw-role-display">Role: ‚Äî</p>
              <div class="uai-badge hidden" id="pw-uai"></div>
            </div>
            <span class="badge badge-success" style="margin-left:auto">Authenticated</span>
          </div>
          <div class="token-field">
            <div class="result-label">Access Token</div>
            <div class="token-value">
              <textarea id="pw-access-token" readonly rows="3"></textarea>
              <button class="btn btn-ghost btn-sm" onclick="copyText('pw-access-token')">Copy</button>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="whoamiWith('pw')">üë§ Whoami</button>
            <button class="btn btn-secondary" onclick="verifyWith('pw')">‚úì Verify</button>
            <button class="btn btn-secondary" onclick="introspectWith('pw')">üî¨ Introspect</button>
            <button class="btn btn-secondary" onclick="inspectToken('pw-access-token')">üîç Decode JWT</button>
          </div>
          <div class="result-box hidden" id="pw-action-result" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- ====== TAB: OTP ====== -->
    <div class="tab-panel" id="tab-otp">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üìß</span>
          <h2>OTP / Magic Link (Passwordless)</h2>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="otpEmail" placeholder="your@email.com" />
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="otpType" onchange="onOtpTypeChange()">
              <option value="email">6-digit OTP</option>
              <option value="magiclink">Magic Link</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary btn-full" onclick="sendOtp()" id="sendOtpBtn">Send OTP</button>
        <div class="result-box hidden" id="otp-send-result" style="margin-top:12px"></div>

        <div id="otp-verify-section" class="hidden" style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
          <div class="form-group">
            <label>OTP Code</label>
            <input type="text" id="otpCode" placeholder="123456" maxlength="6"
              style="font-size:1.4rem;text-align:center;letter-spacing:10px" />
          </div>
          <button class="btn btn-success btn-full" onclick="verifyOtp()">Verify OTP ‚Üí</button>
          <div class="result-box hidden" id="otp-verify-result" style="margin-top:12px"></div>
        </div>

        <div id="otp-authed" class="hidden" style="margin-top:16px">
          <div class="user-card">
            <div class="user-avatar" id="otp-avatar">?</div>
            <div class="user-meta">
              <h3 id="otp-email-display">‚Äî</h3>
              <p id="otp-role-display">Role: ‚Äî</p>
            </div>
            <span class="badge badge-success" style="margin-left:auto">Authenticated</span>
          </div>
          <div class="token-field">
            <div class="result-label">Access Token</div>
            <div class="token-value">
              <textarea id="otp-access-token" readonly rows="3"></textarea>
              <button class="btn btn-ghost btn-sm" onclick="copyText('otp-access-token')">Copy</button>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="whoamiWith('otp')">üë§ Whoami</button>
            <button class="btn btn-secondary" onclick="verifyWith('otp')">‚úì Verify</button>
            <button class="btn btn-secondary" onclick="inspectToken('otp-access-token')">üîç Decode JWT</button>
          </div>
          <div class="result-box hidden" id="otp-action-result" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- ====== TAB: API Key ====== -->
    <div class="tab-panel" id="tab-apikey">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üóùÔ∏è</span>
          <h2>API Key Validation</h2>
          <span class="badge badge-info">POST /v1/auth/verify-api-key</span>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">
          Test API key validation. Expected format: <code style="color:var(--accent)">lano_</code> prefix.<br>
          Also accepts legacy <code style="color:var(--warning)">vx_</code> / <code style="color:var(--warning)">lns_</code> prefixes (deprecated).
        </p>
        <div class="form-group">
          <label>API Key</label>
          <div class="pw-wrap">
            <input type="password" id="apiKeyInput" placeholder="lano_‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <button class="pw-toggle" onclick="togglePw('apiKeyInput',this)">üëÅ</button>
          </div>
        </div>
        <button class="btn btn-primary btn-full" onclick="testApiKey()">Validate API Key</button>
        <div class="result-box hidden" id="apikey-result" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>API Key via Header Test</h2>
          <span class="badge badge-purple">X-API-Key header</span>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Send API key as <code style="color:var(--accent)">X-API-Key</code> header and hit a protected endpoint.</p>
        <div class="form-group">
          <label>API Key</label>
          <input type="text" id="apiKeyHeader" placeholder="lano_..." />
        </div>
        <div class="form-group">
          <label>Endpoint to Test</label>
          <select id="apiKeyEndpoint">
            <option value="/v1/auth/me">GET /v1/auth/me (whoami)</option>
            <option value="/v1/auth/session">GET /v1/auth/session</option>
            <option value="/health">GET /health (public)</option>
          </select>
        </div>
        <button class="btn btn-primary btn-full" onclick="testApiKeyEndpoint()">Test Endpoint with API Key</button>
        <div class="result-box hidden" id="apikey-endpoint-result" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- ====== TAB: Token Inspector ====== -->
    <div class="tab-panel" id="tab-inspector">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üîç</span>
          <h2>JWT Decoder &amp; Inspector</h2>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Paste any JWT to decode header, payload, and verify claims. Highlights UAI field.</p>
        <div class="form-group">
          <label>JWT Token</label>
          <textarea id="inspectorInput" rows="4" placeholder="eyJhbGci‚Ä¶" style="font-family:monospace;font-size:0.78rem" oninput="decodeJwt(this.value)"></textarea>
        </div>
        <div id="jwt-decoded" class="hidden">
          <div class="section-title">Header</div>
          <div class="code-box" id="jwt-header-box" style="margin-bottom:12px"></div>
          <div class="section-title">Payload</div>
          <div id="jwt-payload-fields"></div>
          <div class="section-title">Token Status</div>
          <div id="jwt-status-box" class="code-box"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Quick Inspect from Active Sessions</h2>
        </div>
        <div class="btn-group" style="margin-top:0">
          <button class="btn btn-secondary" onclick="loadTokenIntoInspector('pkce')">Load PKCE Token</button>
          <button class="btn btn-secondary" onclick="loadTokenIntoInspector('pw')">Load Password Token</button>
          <button class="btn btn-secondary" onclick="loadTokenIntoInspector('otp')">Load OTP Token</button>
        </div>
      </div>
    </div>

    <!-- ====== TAB: Whoami ====== -->
    <div class="tab-panel" id="tab-whoami">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üë§</span>
          <h2>GET /v1/auth/me ‚Äî User Profile</h2>
          <span class="badge badge-purple">requireAuth</span>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">
          Fetches the full authenticated user profile. Works for all three token types: gateway JWT, opaque OAuth PKCE token, and API key.
        </p>
        <div class="form-group">
          <label>Bearer Token <span style="color:var(--text-muted)">(or use quick-load below)</span></label>
          <div class="pw-wrap">
            <input type="password" id="whoami-token" placeholder="Access token‚Ä¶" />
            <button class="pw-toggle" onclick="togglePw('whoami-token',this)">üëÅ</button>
          </div>
        </div>
        <div class="btn-group" style="margin-top:0;margin-bottom:14px">
          <button class="btn btn-ghost btn-sm" onclick="loadWhoamiToken('pkce')">Load PKCE token</button>
          <button class="btn btn-ghost btn-sm" onclick="loadWhoamiToken('pw')">Load password token</button>
          <button class="btn btn-ghost btn-sm" onclick="loadWhoamiToken('otp')">Load OTP token</button>
        </div>
        <button class="btn btn-primary btn-full" onclick="runWhoami()">Fetch Profile</button>
        <div class="result-box hidden" id="whoami-result" style="margin-top:12px"></div>

        <div id="whoami-profile" class="hidden" style="margin-top:16px">
          <div class="user-card">
            <div class="user-avatar" id="wm-avatar">?</div>
            <div class="user-meta">
              <h3 id="wm-name">‚Äî</h3>
              <p id="wm-email-p">‚Äî</p>
              <div class="uai-badge" id="wm-uai">UAI: ‚Äî</div>
            </div>
            <div style="margin-left:auto;text-align:right">
              <span class="badge badge-success" id="wm-role-badge">‚Äî</span>
              <br><span class="badge badge-purple" style="margin-top:4px" id="wm-plan-badge">‚Äî</span>
            </div>
          </div>
          <div id="wm-fields"></div>
        </div>
      </div>
    </div>

    <!-- ====== TAB: Endpoint Tester ====== -->
    <div class="tab-panel" id="tab-endpoints">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üì°</span>
          <h2>Endpoint Tester</h2>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px">Fire arbitrary requests against any auth gateway endpoint.</p>
        <div class="form-row">
          <div class="form-group">
            <label>Method</label>
            <select id="ep-method">
              <option>GET</option>
              <option selected>POST</option>
              <option>PUT</option>
              <option>DELETE</option>
            </select>
          </div>
          <div class="form-group">
            <label>Path</label>
            <input type="text" id="ep-path" placeholder="/v1/auth/me" />
          </div>
        </div>
        <div class="form-group">
          <label>Authorization <span style="color:var(--text-muted)">(Bearer token or API key)</span></label>
          <input type="text" id="ep-auth" placeholder="Bearer eyJ‚Ä¶ or lano_‚Ä¶" />
        </div>
        <div class="form-group">
          <label>Request Body (JSON, optional)</label>
          <textarea id="ep-body" rows="4" placeholder='{"key":"value"}' style="font-family:monospace;font-size:0.8rem"></textarea>
        </div>
        <div class="section-title">Quick Endpoints</div>
        <div class="btn-group" style="margin-top:0;margin-bottom:14px;flex-wrap:wrap">
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('GET','/v1/auth/me')">GET /me</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('GET','/v1/auth/session')">GET /session</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('POST','/v1/auth/verify')">POST /verify</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('POST','/oauth/introspect')">POST /introspect</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('GET','/health')">GET /health</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('POST','/v1/auth/logout')">POST /logout</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('POST','/oauth/token')">POST /oauth/token</button>
          <button class="btn btn-ghost btn-sm" onclick="setEndpoint('POST','/register')">POST /register</button>
        </div>
        <button class="btn btn-primary btn-full" onclick="runEndpoint()">Send Request</button>
        <div class="result-box hidden" id="ep-result" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- ====== TAB: Health ====== -->
    <div class="tab-panel" id="tab-health">
      <div class="card">
        <div class="card-header">
          <span class="icon" style="font-size:1.3rem">üíö</span>
          <h2>System Health</h2>
          <button class="btn btn-ghost btn-sm" onclick="checkHealth(true)">Refresh</button>
        </div>
        <div class="health-grid" id="health-grid">
          <div class="health-item"><div class="val" id="h-status">‚Äî</div><div class="lbl">Status</div></div>
          <div class="health-item"><div class="val" id="h-version">‚Äî</div><div class="lbl">Version</div></div>
          <div class="health-item"><div class="val" id="h-uptime">‚Äî</div><div class="lbl">Uptime</div></div>
          <div class="health-item"><div class="val" id="h-db">‚Äî</div><div class="lbl">Database</div></div>
          <div class="health-item"><div class="val" id="h-oauth">‚Äî</div><div class="lbl">OAuth</div></div>
          <div class="health-item"><div class="val" id="h-latency">‚Äî</div><div class="lbl">Latency</div></div>
        </div>
        <div class="result-box hidden" id="health-raw" style="margin-top:16px"></div>
      </div>

      <div class="card">
        <div class="card-header"><h2>All 10 Auth Methods ‚Äî Coverage</h2></div>
        <div id="auth-method-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

    <!-- ====== TAB: Request Log ====== -->
    <div class="tab-panel" id="tab-log">
      <div class="card">
        <div class="card-header">
          <h2>Request Log</h2>
          <button class="btn btn-ghost btn-sm" onclick="clearLog()">Clear</button>
          <button class="btn btn-ghost btn-sm" onclick="exportLog()">Export</button>
        </div>
        <div class="log-panel" id="logPanel" style="max-height:600px">
          <div class="log-row"><span class="log-t">‚Äî</span><span class="log-inf">Waiting for activity‚Ä¶</span></div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const SK = 'agw_test_v2';
let S = {
  pkce: { clientId:null,clientSecret:null,cv:null,cc:null,authState:null,at:null,rt:null,user:null,expAt:null },
  pw:   { at:null,rt:null,user:null },
  otp:  { at:null,rt:null,user:null },
};
let logEntries = [];
let expiryTimer = null;

function save(){ try{ sessionStorage.setItem(SK,JSON.stringify(S)); }catch(e){} }
function load(){ try{ const d=sessionStorage.getItem(SK); if(d) S=JSON.parse(d); }catch(e){} }

// ============================================================
// INIT
// ============================================================
window.onload = function(){
  load();
  document.getElementById('redirectUri').value = pageUrl();
  document.getElementById('baseUrlInput').value = 'https://auth.lanonasis.com';
  document.getElementById('envSelect').value = 'production';

  // Check for OAuth callback
  const p = new URLSearchParams(location.search);
  if(p.has('code')){ handleCallback(p); return; }
  if(p.has('error')){ showPkceError(p.get('error'), p.get('error_description')); return; }

  restoreUI();
  checkHealth();
  renderAuthMethodGrid();
};

function pageUrl(){
  const u = new URL(location.href);
  u.search=''; u.hash='';
  return u.toString();
}

function getBase(){ return document.getElementById('baseUrlInput').value.replace(/\/$/,''); }

function onEnvChange(){
  const m = {local:'http://localhost:4000',staging:'https://auth-staging.lanonasis.com',production:'https://auth.lanonasis.com'};
  document.getElementById('baseUrlInput').value = m[document.getElementById('envSelect').value] || '';
  checkHealth();
}

function showTab(id,el){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  if(el) el.classList.add('active');
}

// ============================================================
// HEALTH
// ============================================================
async function checkHealth(verbose){
  const badge = document.getElementById('healthBadge');
  badge.className='badge badge-warning'; badge.textContent='‚óè Checking';
  const t0=Date.now();
  try{
    const res = await fetch(getBase()+'/health');
    const ms = Date.now()-t0;
    const data = await res.json();
    if(res.ok && (data.status==='ok'||data.status==='healthy')){
      badge.className='badge badge-success'; badge.textContent='‚óè Connected';
    } else {
      badge.className='badge badge-warning'; badge.textContent='‚óè '+( data.status||'Degraded');
    }
    // Fill health tab
    const fmt = v => v!=null ? String(v) : '‚Äî';
    set('h-status', data.status||'ok');
    set('h-version', data.version||data.app?.version||'‚Äî');
    set('h-uptime', data.uptime ? fmtUptime(data.uptime) : '‚Äî');
    set('h-db', data.database||data.db||'‚Äî');
    set('h-oauth', data.oauth||data.services?.oauth||'‚Äî');
    set('h-latency', ms+'ms');
    if(verbose){
      show('health-raw');
      document.getElementById('health-raw').innerHTML=`<pre>${JSON.stringify(data,null,2)}</pre>`;
    }
    httpLog('GET','/health',res.status,ms,'');
  } catch(err){
    badge.className='badge badge-error'; badge.textContent='‚óè Offline';
    httpLog('GET','/health',0,Date.now()-t0,'error:'+err.message);
  }
}

function fmtUptime(s){
  if(typeof s==='string') return s;
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);
  return h+'h '+m+'m';
}

// ============================================================
// TAB: OAuth PKCE
// ============================================================
function restoreUI(){
  if(S.pkce.clientId){
    markStep('s1');
    document.getElementById('pkceBtn').disabled=false;
    document.getElementById('registerBtn').textContent='Registered ‚úì';
  }
  if(S.pkce.cv){
    markStep('s2');
    document.getElementById('cvDisplay').textContent=S.pkce.cv;
    document.getElementById('ccDisplay').textContent=S.pkce.cc;
    show('pkce-display');
    document.getElementById('startAuthBtn').disabled=false;
    updateAuthUrl();
  }
  if(S.pkce.at){ showPkceAuthed(); }
}

async function registerClient(){
  const btn=document.getElementById('registerBtn');
  btn.disabled=true; btn.textContent='Registering‚Ä¶';
  const t0=Date.now();
  try{
    const body={
      client_name: document.getElementById('clientName').value,
      redirect_uris: [pageUrl()],
      grant_types: ['authorization_code'],
      response_types: ['code'],
      scope: document.getElementById('scopes').value,
      token_endpoint_auth_method: 'none'
    };
    const res = await fetch(getBase()+'/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data = await res.json();
    httpLog('POST','/register',res.status,Date.now()-t0,res.ok?'':'error');
    if(!res.ok) throw new Error(data.error_description||data.error||'Registration failed');
    S.pkce.clientId=data.client_id; S.pkce.clientSecret=data.client_secret; save();
    showResult('r-register','ok',data);
    markStep('s1');
    document.getElementById('pkceBtn').disabled=false;
    document.getElementById('fn-client').classList.add('done');
    btn.textContent='Registered ‚úì';
  } catch(err){
    showResult('r-register','err',{error:err.message});
    btn.disabled=false; btn.textContent='Register Client';
  }
}

async function generatePKCE(){
  const arr=new Uint8Array(32); crypto.getRandomValues(arr);
  const cv=b64url(arr);
  const enc=new TextEncoder();
  const dig=await crypto.subtle.digest('SHA-256',enc.encode(cv));
  const cc=b64url(new Uint8Array(dig));
  const st=b64url(new Uint8Array(16).fill(0).map(()=>{crypto.getRandomValues(new Uint8Array(1)); return crypto.getRandomValues(new Uint8Array(1))[0];}));
  const stArr=new Uint8Array(16); crypto.getRandomValues(stArr);
  S.pkce.cv=cv; S.pkce.cc=cc; S.pkce.authState=b64url(stArr); save();
  document.getElementById('cvDisplay').textContent=cv;
  document.getElementById('ccDisplay').textContent=cc;
  show('pkce-display');
  markStep('s2');
  document.getElementById('startAuthBtn').disabled=false;
  document.getElementById('fn-pkce').classList.add('done');
  updateAuthUrl();
}

function b64url(buf){ return btoa(String.fromCharCode(...buf)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }

function updateAuthUrl(){
  if(!S.pkce.clientId||!S.pkce.cc) return;
  const u=new URL(getBase()+'/oauth/authorize');
  u.searchParams.set('response_type','code');
  u.searchParams.set('client_id',S.pkce.clientId);
  u.searchParams.set('redirect_uri',pageUrl());
  u.searchParams.set('scope',document.getElementById('scopes').value);
  u.searchParams.set('state',S.pkce.authState);
  u.searchParams.set('code_challenge',S.pkce.cc);
  u.searchParams.set('code_challenge_method','S256');
  document.getElementById('authUrlDisplay').textContent=u.toString();
  document.getElementById('authUrlDisplay').style.color='var(--success)';
}

function startOAuthFlow(){
  document.getElementById('fn-auth').classList.add('active');
  const u=new URL(getBase()+'/oauth/authorize');
  u.searchParams.set('response_type','code');
  u.searchParams.set('client_id',S.pkce.clientId);
  u.searchParams.set('redirect_uri',pageUrl());
  u.searchParams.set('scope',document.getElementById('scopes').value);
  u.searchParams.set('state',S.pkce.authState);
  u.searchParams.set('code_challenge',S.pkce.cc);
  u.searchParams.set('code_challenge_method','S256');
  location.href=u.toString();
}

async function handleCallback(params){
  hide('pkce-preauth'); show('pkce-callback');
  const code=params.get('code'), retState=params.get('state');
  document.getElementById('authCodeDisplay').textContent=code;
  document.getElementById('stateDisplay').textContent=retState;
  load();
  if(retState!==S.pkce.authState){
    showPkceError('state_mismatch','The state parameter does not match. Possible CSRF attack.');
    return;
  }
  document.getElementById('fn-callback').classList.add('done');
  document.getElementById('fn-exchange').classList.add('active');
  const t0=Date.now();
  try{
    const body=new URLSearchParams({
      grant_type:'authorization_code', code,
      redirect_uri:pageUrl(),
      client_id:S.pkce.clientId,
      code_verifier:S.pkce.cv
    });
    const res=await fetch(getBase()+'/oauth/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body.toString()});
    const data=await res.json();
    httpLog('POST','/oauth/token',res.status,Date.now()-t0,res.ok?'':'error');
    document.getElementById('exchangeResult').innerHTML=`<pre>${JSON.stringify(data,null,2)}</pre>`;
    document.getElementById('exchangeResult').className='result-box '+(res.ok?'ok':'err');
    if(!res.ok) throw new Error(data.error_description||data.error||'Token exchange failed');
    S.pkce.at=data.access_token; S.pkce.rt=data.refresh_token;
    S.pkce.expAt=data.expires_in?Date.now()+data.expires_in*1000:null;
    S.pkce.user=data.user||{};
    save();
    document.getElementById('fn-exchange').classList.remove('active');
    document.getElementById('fn-exchange').classList.add('done');
    document.getElementById('fn-done').classList.add('done');
    history.replaceState({},document.title,location.pathname);
    setTimeout(()=>showPkceAuthed(),400);
  } catch(err){
    showPkceError('token_exchange_failed',err.message);
  }
}

function showPkceAuthed(){
  hide('pkce-preauth'); hide('pkce-callback'); hide('pkce-error'); show('pkce-authed');
  document.getElementById('pkce-access-token').value=S.pkce.at||'';
  document.getElementById('pkce-refresh-token').value=S.pkce.rt||'';
  // Decode to get user info
  const pl=tryDecodeJwt(S.pkce.at);
  const email=pl?.email||S.pkce.user?.email||'Unknown';
  const role=pl?.role||S.pkce.user?.role||'authenticated';
  const uai=pl?.uai;
  set('pkce-email',email);
  set('pkce-role','Role: '+role);
  set('pkce-avatar',email.charAt(0).toUpperCase());
  if(uai){ show('pkce-uai'); document.getElementById('pkce-uai').textContent='UAI: '+uai.slice(0,18)+'‚Ä¶'; }
  startExpiryCountdown('pkce-expiry','pkce-expiry-fill',pl?.exp);
  ['fn-client','fn-pkce','fn-auth','fn-login','fn-callback','fn-exchange','fn-done'].forEach(id=>{
    const el=document.getElementById(id);
    el.classList.remove('active'); el.classList.add('done');
  });
}

function showPkceError(error,desc){
  hide('pkce-preauth'); hide('pkce-callback');
  show('pkce-error');
  document.getElementById('pkce-error-box').innerHTML=`<div class="result-label">Error: ${error}</div><pre>${desc||''}</pre>`;
  document.getElementById('pkce-error-box').className='result-box err';
}

function resetPkce(){
  S.pkce={clientId:null,clientSecret:null,cv:null,cc:null,authState:null,at:null,rt:null,user:null,expAt:null};
  save();
  history.replaceState({},document.title,location.pathname);
  location.reload();
}

async function verifyToken(){
  const t0=Date.now();
  const res=await authedFetch('POST','/v1/auth/verify',null,S.pkce.at);
  httpLog('POST','/v1/auth/verify',res.status,Date.now()-t0,'');
  showResult('pkce-action-result',res.ok?'ok':'err',res.data);
}

async function getSession(){
  const t0=Date.now();
  const res=await authedFetch('GET','/v1/auth/session',null,S.pkce.at);
  httpLog('GET','/v1/auth/session',res.status,Date.now()-t0,'');
  showResult('pkce-action-result',res.ok?'ok':'err',res.data);
}

async function introspectToken(){
  const t0=Date.now();
  const res=await jsonFetch('POST','/oauth/introspect',{token:S.pkce.at});
  httpLog('POST','/oauth/introspect',res.status,Date.now()-t0,'');
  showResult('pkce-action-result',res.ok?'ok':'err',res.data);
}

async function refreshAccessToken(){
  if(!S.pkce.rt){ showResult('pkce-action-result','err',{error:'No refresh token stored'}); return; }
  const t0=Date.now();
  const body=new URLSearchParams({grant_type:'refresh_token',refresh_token:S.pkce.rt,client_id:S.pkce.clientId});
  const r=await fetch(getBase()+'/oauth/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body.toString()});
  const data=await r.json();
  httpLog('POST','/oauth/token (refresh)',r.status,Date.now()-t0,'');
  if(r.ok){ S.pkce.at=data.access_token; if(data.refresh_token) S.pkce.rt=data.refresh_token; save(); document.getElementById('pkce-access-token').value=S.pkce.at; }
  showResult('pkce-action-result',r.ok?'ok':'err',data);
}

async function logoutOAuth(){
  const t0=Date.now();
  const res=await authedFetch('POST','/v1/auth/logout',null,S.pkce.at);
  httpLog('POST','/v1/auth/logout',res.status,Date.now()-t0,'');
  showResult('pkce-action-result',res.ok?'ok':'warn',res.data);
  if(res.ok) setTimeout(resetPkce,1200);
}

async function whoami(){
  const t0=Date.now();
  const res=await authedFetch('GET','/v1/auth/me',null,S.pkce.at);
  httpLog('GET','/v1/auth/me',res.status,Date.now()-t0,'');
  showResult('pkce-action-result',res.ok?'ok':'err',res.data);
  if(res.ok){
    const d=res.data;
    set('pkce-email',d.email||d.user?.email||'‚Äî');
    const uai=d.uai||d.auth_id||d.user?.uai;
    if(uai){ show('pkce-uai'); document.getElementById('pkce-uai').textContent='UAI: '+uai; }
  }
}

// ============================================================
// TAB: Password Login
// ============================================================
async function passwordLogin(){
  const email=document.getElementById('pw-email').value;
  const pass=document.getElementById('pw-pass').value;
  const platform=document.getElementById('pw-platform').value;
  const scope=document.getElementById('pw-scope').value;
  if(!email||!pass){ alert('Email and password required'); return; }
  const t0=Date.now();
  const res=await jsonFetch('POST','/v1/auth/login',{email,password:pass,platform,project_scope:scope||undefined});
  httpLog('POST','/v1/auth/login',res.status,Date.now()-t0,'');
  showResult('pw-result',res.ok?'ok':'err',res.data);
  if(res.ok){
    S.pw.at=res.data.access_token||res.data.token;
    S.pw.rt=res.data.refresh_token;
    S.pw.user=res.data.user||{};
    save();
    document.getElementById('pw-access-token').value=S.pw.at||'';
    const pl=tryDecodeJwt(S.pw.at);
    const uemail=pl?.email||S.pw.user?.email||email;
    set('pw-email-display',uemail);
    set('pw-role-display','Role: '+(pl?.role||'authenticated'));
    set('pw-avatar',uemail.charAt(0).toUpperCase());
    const uai=pl?.uai; if(uai){ show('pw-uai'); document.getElementById('pw-uai').textContent='UAI: '+uai.slice(0,18)+'‚Ä¶'; }
    show('pw-authed');
  }
}

async function whoamiWith(src){
  const token=S[src]?.at; if(!token){ showResult(src+'-action-result','err',{error:'No token ‚Äî authenticate first'}); return; }
  const t0=Date.now();
  const res=await authedFetch('GET','/v1/auth/me',null,token);
  httpLog('GET','/v1/auth/me',res.status,Date.now()-t0,'');
  showResult(src+'-action-result',res.ok?'ok':'err',res.data);
}

async function verifyWith(src){
  const token=S[src]?.at; if(!token){ showResult(src+'-action-result','err',{error:'No token'}); return; }
  const t0=Date.now();
  const res=await authedFetch('POST','/v1/auth/verify',null,token);
  httpLog('POST','/v1/auth/verify',res.status,Date.now()-t0,'');
  showResult(src+'-action-result',res.ok?'ok':'err',res.data);
}

async function introspectWith(src){
  const token=S[src]?.at; if(!token){ showResult(src+'-action-result','err',{error:'No token'}); return; }
  const t0=Date.now();
  const res=await jsonFetch('POST','/oauth/introspect',{token});
  httpLog('POST','/oauth/introspect',res.status,Date.now()-t0,'');
  showResult(src+'-action-result',res.ok?'ok':'err',res.data);
}

function inspectToken(inputId){
  const val=document.getElementById(inputId).value;
  if(!val) return;
  document.getElementById('inspectorInput').value=val;
  decodeJwt(val);
  showTab('inspector',document.querySelector('.nav-item:nth-child(2)'));
}

// ============================================================
// TAB: OTP
// ============================================================
function onOtpTypeChange(){
  const t=document.getElementById('otpType').value;
  document.getElementById('sendOtpBtn').textContent=t==='magiclink'?'Send Magic Link':'Send OTP';
}

async function sendOtp(){
  const email=document.getElementById('otpEmail').value;
  const type=document.getElementById('otpType').value;
  if(!email){ alert('Email required'); return; }
  const btn=document.getElementById('sendOtpBtn');
  btn.disabled=true; btn.textContent='Sending‚Ä¶';
  const t0=Date.now();
  const res=await jsonFetch('POST','/otp/send',{email,type});
  httpLog('POST','/otp/send',res.status,Date.now()-t0,'');
  showResult('otp-send-result',res.ok?'ok':'err',res.data);
  btn.disabled=false; btn.textContent=type==='magiclink'?'Resend Magic Link':'Resend OTP';
  if(res.ok && type!=='magiclink') show('otp-verify-section');
}

async function verifyOtp(){
  const email=document.getElementById('otpEmail').value;
  const token=document.getElementById('otpCode').value;
  const type=document.getElementById('otpType').value;
  if(!token){ alert('OTP code required'); return; }
  const t0=Date.now();
  const res=await jsonFetch('POST','/otp/verify',{email,token,type});
  httpLog('POST','/otp/verify',res.status,Date.now()-t0,'');
  showResult('otp-verify-result',res.ok?'ok':'err',res.data);
  if(res.ok && res.data.access_token){
    S.otp.at=res.data.access_token; S.otp.rt=res.data.refresh_token; S.otp.user=res.data.user||{}; save();
    document.getElementById('otp-access-token').value=S.otp.at;
    const pl=tryDecodeJwt(S.otp.at);
    const uemail=pl?.email||S.otp.user?.email||email;
    set('otp-email-display',uemail); set('otp-role-display','Role: '+(pl?.role||'authenticated'));
    set('otp-avatar',uemail.charAt(0).toUpperCase());
    show('otp-authed');
  }
}

// ============================================================
// TAB: API Key
// ============================================================
async function testApiKey(){
  const key=document.getElementById('apiKeyInput').value;
  if(!key){ alert('API key required'); return; }
  const t0=Date.now();
  const res=await fetch(getBase()+'/v1/auth/verify-api-key',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':key},body:JSON.stringify({api_key:key})});
  const data=await res.json(); httpLog('POST','/v1/auth/verify-api-key',res.status,Date.now()-t0,'');
  showResult('apikey-result',res.ok?'ok':'err',data);
}

async function testApiKeyEndpoint(){
  const key=document.getElementById('apiKeyHeader').value;
  const path=document.getElementById('apiKeyEndpoint').value;
  if(!key){ alert('API key required'); return; }
  const t0=Date.now();
  const headers={'X-API-Key':key};
  const res=await fetch(getBase()+path,{headers});
  const data=await safeJson(res); httpLog('GET',path,res.status,Date.now()-t0,'');
  showResult('apikey-endpoint-result',res.ok?'ok':'err',data);
}

// ============================================================
// TAB: Token Inspector
// ============================================================
function loadTokenIntoInspector(src){
  const t=S[src]?.at; if(!t){ alert('No token for this session'); return; }
  document.getElementById('inspectorInput').value=t;
  decodeJwt(t);
}

function decodeJwt(token){
  if(!token||token.split('.').length!==3){ hide('jwt-decoded'); return; }
  try{
    const [hb64,pb64]=token.split('.');
    const header=JSON.parse(atob(hb64.replace(/-/g,'+').replace(/_/g,'/')));
    const payload=JSON.parse(atob(pb64.replace(/-/g,'+').replace(/_/g,'/')));
    show('jwt-decoded');
    document.getElementById('jwt-header-box').innerHTML=`<pre>${JSON.stringify(header,null,2)}</pre>`;
    // Render payload fields
    const now=Math.floor(Date.now()/1000);
    let rows='';
    const specialKeys=['uai','sub','email','role','exp','iat','plan','platform','project_scope','organization_id'];
    const allKeys=[...specialKeys,...Object.keys(payload).filter(k=>!specialKeys.includes(k))];
    for(const k of allKeys){
      if(!(k in payload)) continue;
      let v=payload[k];
      let cls='jwt-val';
      let display=typeof v==='object'?JSON.stringify(v):String(v);
      if(k==='uai'){ cls='jwt-val uai'; display='üîë '+display; }
      else if(k==='exp'){
        const rem=v-now;
        if(rem>300) cls='jwt-val exp-ok';
        else if(rem>0) cls='jwt-val exp-warn';
        else cls='jwt-val exp-bad';
        display=new Date(v*1000).toLocaleString()+` (${rem>0?'+'+rem+'s':'expired '+(-rem)+'s ago'})`;
      } else if(k==='iat'){
        display=new Date(v*1000).toLocaleString();
      }
      rows+=`<div class="jwt-payload-field"><span class="jwt-key">${k}</span><span class="${cls}">${display}</span></div>`;
    }
    document.getElementById('jwt-payload-fields').innerHTML=`<div class="code-box">${rows}</div>`;
    // Status
    const exp=payload.exp;
    const hasUai=!!payload.uai;
    const expired=exp&&now>exp;
    document.getElementById('jwt-status-box').innerHTML=`
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <span class="badge ${expired?'badge-error':'badge-success'}">${expired?'‚ö† Expired':'‚úì Valid'}</span>
        <span class="badge ${hasUai?'badge-purple':'badge-warning'}">${hasUai?'‚úì UAI embedded':'‚ö† No UAI (legacy token)'}</span>
        ${payload.platform?`<span class="badge badge-info">platform: ${payload.platform}</span>`:''}
        ${payload.role?`<span class="badge badge-info">role: ${payload.role}</span>`:''}
      </div>`;
  } catch(e){ hide('jwt-decoded'); }
}

// ============================================================
// TAB: Whoami
// ============================================================
function loadWhoamiToken(src){
  const t=S[src]?.at; if(!t){ alert('No token for this session'); return; }
  document.getElementById('whoami-token').value=t;
}

async function runWhoami(){
  const token=document.getElementById('whoami-token').value;
  if(!token){ alert('Token required'); return; }
  const t0=Date.now();
  const res=await authedFetch('GET','/v1/auth/me',null,token);
  httpLog('GET','/v1/auth/me',res.status,Date.now()-t0,'');
  showResult('whoami-result',res.ok?'ok':'err',res.data);
  if(res.ok){
    const d=res.data;
    const profile=d.user||d;
    show('whoami-profile');
    set('wm-avatar',(profile.email||'?').charAt(0).toUpperCase());
    set('wm-name',profile.name||profile.email||'‚Äî');
    set('wm-email-p',profile.email||'‚Äî');
    document.getElementById('wm-uai').textContent='UAI: '+(profile.uai||profile.auth_id||d.uai||'‚Äî');
    document.getElementById('wm-role-badge').textContent=profile.role||'‚Äî';
    document.getElementById('wm-plan-badge').textContent='Plan: '+(profile.plan||profile.metadata?.plan||'‚Äî');
    // Extra fields
    const extra=['provider','platform','project_scope','last_sign_in_at','created_at'];
    let html='<div class="code-box" style="margin-top:12px">';
    for(const k of extra){
      const v=profile[k]||profile.metadata?.[k];
      if(v) html+=`<div class="jwt-payload-field"><span class="jwt-key">${k}</span><span class="jwt-val">${v}</span></div>`;
    }
    html+='</div>';
    document.getElementById('wm-fields').innerHTML=html;
  }
}

// ============================================================
// TAB: Endpoint Tester
// ============================================================
function setEndpoint(method,path){
  document.getElementById('ep-method').value=method;
  document.getElementById('ep-path').value=path;
  // Auto-load active token if available
  const t=S.pkce.at||S.pw.at||S.otp.at;
  if(t && !document.getElementById('ep-auth').value) document.getElementById('ep-auth').value='Bearer '+t;
}

async function runEndpoint(){
  const method=document.getElementById('ep-method').value;
  const path=document.getElementById('ep-path').value.trim();
  const auth=document.getElementById('ep-auth').value.trim();
  const bodyRaw=document.getElementById('ep-body').value.trim();
  if(!path){ alert('Path required'); return; }
  const headers={};
  if(auth){
    if(auth.startsWith('Bearer ')||auth.startsWith('bearer ')) headers['Authorization']=auth;
    else if(auth.startsWith('lano_')||auth.startsWith('vx_')||auth.startsWith('lns_')) headers['X-API-Key']=auth;
    else headers['Authorization']='Bearer '+auth;
  }
  if(bodyRaw) headers['Content-Type']='application/json';
  const t0=Date.now();
  try{
    const opts={method,headers};
    if(bodyRaw&&method!=='GET') opts.body=bodyRaw;
    const res=await fetch(getBase()+path,opts);
    const data=await safeJson(res);
    httpLog(method,path,res.status,Date.now()-t0,'');
    showResult('ep-result',res.ok?'ok':(res.status>=500?'warn':'err'),data);
  } catch(err){
    showResult('ep-result','err',{error:err.message});
  }
}

// ============================================================
// AUTH METHOD GRID
// ============================================================
function renderAuthMethodGrid(){
  const methods=[
    {id:'oauth_pkce',label:'OAuth PKCE',tested:'pkce',note:'Full PKCE flow tab'},
    {id:'password',label:'Password Login',tested:'pw',note:'Password tab'},
    {id:'magic_link',label:'Magic Link',tested:'otp',note:'OTP/Magic tab'},
    {id:'otp_email',label:'OTP Email',tested:'otp',note:'OTP/Magic tab'},
    {id:'api_key',label:'API Key (lano_)',tested:'apikey',note:'API Key tab'},
    {id:'supabase_jwt',label:'Supabase JWT',tested:null,note:'Social OAuth ‚Äî use PKCE with social provider'},
    {id:'oauth_token',label:'OAuth Token (opaque)',tested:null,note:'Auto-tested by requireAuth fix'},
    {id:'mcp_token',label:'MCP Token',tested:null,note:'Via MCP session'},
    {id:'sso_session',label:'SSO Session',tested:null,note:'Enterprise SSO (not yet exposed)'},
    {id:'passkey',label:'Passkey / Device',tested:null,note:'Device code flow'},
  ];
  const grid=document.getElementById('auth-method-grid');
  grid.innerHTML=methods.map(m=>`
    <div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:10px 14px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <span style="font-size:0.85rem;font-weight:600;color:var(--text-primary)">${m.label}</span>
        <span class="badge ${m.tested?'badge-success':'badge-warning'}" style="font-size:0.62rem">${m.tested?'‚úì testable':'partial'}</span>
      </div>
      <div style="font-size:0.72rem;color:var(--text-muted)">${m.id}</div>
      <div style="font-size:0.72rem;color:var(--text-secondary);margin-top:2px">${m.note}</div>
    </div>
  `).join('');
}

// ============================================================
// UTILITIES
// ============================================================
async function authedFetch(method,path,body,token){
  const headers={'Authorization':'Bearer '+token};
  if(body) headers['Content-Type']='application/json';
  try{
    const res=await fetch(getBase()+path,{method,headers,body:body?JSON.stringify(body):undefined});
    const data=await safeJson(res);
    return {ok:res.ok,status:res.status,data};
  } catch(err){ return {ok:false,status:0,data:{error:err.message}}; }
}

async function jsonFetch(method,path,body){
  try{
    const res=await fetch(getBase()+path,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await safeJson(res);
    return {ok:res.ok,status:res.status,data};
  } catch(err){ return {ok:false,status:0,data:{error:err.message}}; }
}

async function safeJson(res){ try{ return await res.json(); }catch(e){ return {raw:await res.text().catch(()=>'')}; } }

function tryDecodeJwt(token){
  try{
    if(!token||token.split('.').length!==3) return null;
    return JSON.parse(atob(token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
  } catch(e){ return null; }
}

function showResult(id,type,data){
  const el=document.getElementById(id);
  if(!el) return;
  el.className='result-box '+type;
  el.innerHTML=`<pre>${typeof data==='string'?data:JSON.stringify(data,null,2)}</pre>`;
  el.classList.remove('hidden');
}

function set(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }
function show(id){ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
function hide(id){ const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
function markStep(id){ const el=document.getElementById(id); if(el){ el.classList.add('done'); el.textContent='‚úì'; } }

function copyText(id){
  const el=document.getElementById(id);
  if(!el) return;
  const val=el.tagName==='TEXTAREA'?el.value:el.textContent;
  navigator.clipboard.writeText(val).then(()=>{
    const orig=el.closest('.token-value')?.querySelector('.btn')||null;
    if(orig){ const t=orig.textContent; orig.textContent='Copied!'; setTimeout(()=>orig.textContent=t,1500); }
  });
}

function togglePw(id,btn){
  const el=document.getElementById(id);
  if(!el) return;
  el.type=el.type==='password'?'text':'password';
  btn.textContent=el.type==='password'?'üëÅ':'üôà';
}

// ============================================================
// EXPIRY COUNTDOWN
// ============================================================
function startExpiryCountdown(labelId,barId,expUnix){
  if(expiryTimer) clearInterval(expiryTimer);
  if(!expUnix) return;
  const total=expUnix-Math.floor(Date.now()/1000);
  const tick=()=>{
    const rem=expUnix-Math.floor(Date.now()/1000);
    const label=document.getElementById(labelId);
    const bar=document.getElementById(barId);
    if(!label) return;
    if(rem<=0){ label.textContent='Expired'; label.style.color='var(--error)'; if(bar){bar.style.width='0%';bar.style.background='var(--error)';} clearInterval(expiryTimer); return; }
    const h=Math.floor(rem/3600),m=Math.floor((rem%3600)/60),s=rem%60;
    label.textContent=h?`${h}h ${m}m`:`${m}m ${s}s`;
    const pct=Math.max(0,Math.min(100,(rem/total)*100));
    if(bar){
      bar.style.width=pct+'%';
      bar.style.background=pct>30?'var(--success)':pct>10?'var(--warning)':'var(--error)';
    }
    label.style.color=pct>30?'var(--success)':pct>10?'var(--warning)':'var(--error)';
  };
  tick();
  expiryTimer=setInterval(tick,1000);
}

// ============================================================
// HTTP REQUEST LOG
// ============================================================
let logCount=0;
function httpLog(method,path,status,ms,note){
  logCount++;
  set('log-count',String(logCount));
  const row={method,path,status,ms,note,t:new Date().toLocaleTimeString()};
  logEntries.unshift(row);
  const panel=document.getElementById('logPanel');
  const statusCls=status>=500?'s5xx':status>=400?'s4xx':status>=200?'s2xx':'';
  const methodCls=method==='GET'?'log-inf':method==='POST'?'log-ok':'log-warn';
  const el=document.createElement('div');
  el.className='log-row';
  el.innerHTML=`<span class="log-t">${row.t}</span><span class="log-method ${methodCls}">${method}</span><span class="log-url">${path}${note?' ‚Äî '+note:''}</span>${status?`<span class="log-status ${statusCls}">${status}</span>`:''}<span class="log-ms">${ms}ms</span>`;
  if(panel.querySelector('.log-row .log-inf')?.textContent.includes('Waiting')){
    panel.innerHTML='';
  }
  panel.insertBefore(el,panel.firstChild);
}

function clearLog(){
  logEntries=[];logCount=0;set('log-count','0');
  document.getElementById('logPanel').innerHTML='<div class="log-row"><span class="log-t">‚Äî</span><span class="log-inf">Log cleared</span></div>';
}

function exportLog(){
  const lines=logEntries.map(r=>`[${r.t}] ${r.method} ${r.path} ‚Üí ${r.status} (${r.ms}ms)${r.note?' '+r.note:''}`).join('\n');
  const a=document.createElement('a');
  a.href='data:text/plain,'+encodeURIComponent(lines);
  a.download='auth-gateway-log.txt';
  a.click();
}
</script>
</body>
</html>
