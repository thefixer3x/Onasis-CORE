# =============================================================================
# Unified Nginx Gateway Configuration
# =============================================================================
# Consolidates routing for all Lanonasis services:
# - Auth Gateway (ports 4000-4001)
# - Memory Service (port 3000)
# - MCP Protocol (port 8080)
#
# Domains served:
# - api.lanonasis.com (primary gateway)
# - mcp.lanonasis.com (MCP WebSocket/SSE)
# - memory.lanonasis.com (memory service alias)
# =============================================================================

# -----------------------------------------------------------------------------
# Upstream Backends
# -----------------------------------------------------------------------------

# Auth Gateway - PM2 cluster with 2 instances
upstream auth_backend {
    least_conn;
    server 127.0.0.1:4000 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:4001 max_fails=3 fail_timeout=30s backup;
    keepalive 64;
}

# Memory Service - Docker/K8s deployment
upstream memory_backend {
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# MCP Protocol Server - WebSocket/SSE enabled
upstream mcp_backend {
    server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# -----------------------------------------------------------------------------
# Rate Limiting Zones
# -----------------------------------------------------------------------------

# General API rate limit: 10 requests/second
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Login endpoints: 5 requests/minute (stricter for auth)
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

# Memory operations: 100 requests/minute
limit_req_zone $binary_remote_addr zone=memory_limit:10m rate=100r/m;

# AI/Intelligence operations: 20 requests/minute
limit_req_zone $binary_remote_addr zone=ai_limit:10m rate=20r/m;

# -----------------------------------------------------------------------------
# HTTP to HTTPS Redirect
# -----------------------------------------------------------------------------

server {
    listen 80;
    listen [::]:80;
    server_name api.lanonasis.com mcp.lanonasis.com memory.lanonasis.com;
    return 301 https://$server_name$request_uri;
}

# -----------------------------------------------------------------------------
# Main HTTPS Server - api.lanonasis.com
# -----------------------------------------------------------------------------

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.lanonasis.com memory.lanonasis.com;

    # -------------------------------------------------------------------------
    # SSL Configuration
    # -------------------------------------------------------------------------
    ssl_certificate /etc/letsencrypt/live/api.lanonasis.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.lanonasis.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.lanonasis.com wss://*.lanonasis.com" always;

    # -------------------------------------------------------------------------
    # CORS Configuration
    # -------------------------------------------------------------------------
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-API-Key' always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    access_log /var/log/nginx/unified-gateway-access.log;
    error_log /var/log/nginx/unified-gateway-error.log;

    # Max body size (10MB for file uploads)
    client_max_body_size 10M;

    # =========================================================================
    # HEALTH CHECK ENDPOINTS (No Rate Limiting)
    # =========================================================================

    # Unified health check - aggregates all service statuses
    location = /health {
        proxy_pass http://auth_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        access_log off;
    }

    # Auth Gateway health
    location = /health/auth {
        proxy_pass http://auth_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # Memory Service health
    location = /health/memory {
        proxy_pass http://memory_backend/api/v1/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # MCP Server health
    location = /health/mcp {
        proxy_pass http://mcp_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # =========================================================================
    # AUTH GATEWAY ROUTES (Port 4000-4001)
    # =========================================================================

    # Authentication endpoints - stricter rate limiting
    location ~ ^/v1/auth/(login|register|reset-password|verify) {
        limit_req zone=login_limit burst=10 nodelay;

        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        # Pass cookies for session management
        proxy_pass_header Set-Cookie;
        proxy_pass_header Cookie;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # All other v1/auth/* routes
    location ~ ^/v1/auth/ {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Set-Cookie;
        proxy_pass_header Cookie;
    }

    # OAuth endpoints
    location ~ ^/oauth/ {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # CLI authentication
    location ~ ^/auth/cli {
        limit_req zone=login_limit burst=10 nodelay;

        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # MEMORY SERVICE ROUTES (Port 3000)
    # =========================================================================

    # Memory CRUD operations
    location ~ ^/api/v1/(memories|memory)(/|$) {
        limit_req zone=memory_limit burst=50 nodelay;

        proxy_pass http://memory_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-API-Key $http_x_api_key;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # API Keys management
    location ~ ^/api/v1/api-keys {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://memory_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # Projects management
    location ~ ^/api/v1/projects {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://memory_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # Organizations
    location ~ ^/api/v1/organizations {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://memory_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # Memory Service health endpoint
    location = /api/v1/health {
        proxy_pass http://memory_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # =========================================================================
    # INTELLIGENCE/AI ROUTES (Supabase Edge Functions)
    # =========================================================================

    location /api/v1/intelligence/ {
        limit_req zone=ai_limit burst=10 nodelay;

        # Rewrite to Supabase Edge Function URL
        rewrite ^/api/v1/intelligence/(.*)$ /functions/v1/intelligence-$1 break;

        proxy_pass https://mxtsdgkwzjzlttpotole.supabase.co;
        proxy_http_version 1.1;
        proxy_ssl_server_name on;
        proxy_set_header Host mxtsdgkwzjzlttpotole.supabase.co;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Content-Type $http_content_type;

        # Extended timeout for AI operations
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # =========================================================================
    # MCP ROUTES (Proxied from api.lanonasis.com)
    # =========================================================================

    # MCP WebSocket endpoint
    location /mcp {
        proxy_pass http://mcp_backend/mcp;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Keep WebSocket alive
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # =========================================================================
    # METRICS ENDPOINT (Internal Only)
    # =========================================================================

    location /metrics {
        # Restrict to internal networks only
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;

        proxy_pass http://memory_backend/api/v1/metrics;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # =========================================================================
    # DEFAULT FALLBACK
    # =========================================================================

    location / {
        limit_req zone=api_limit burst=20 nodelay;

        # Default to Auth Gateway for unmatched routes
        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# -----------------------------------------------------------------------------
# MCP Server - mcp.lanonasis.com (WebSocket/SSE Optimized)
# -----------------------------------------------------------------------------

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mcp.lanonasis.com;

    # SSL Configuration (same as main server)
    ssl_certificate /etc/letsencrypt/live/mcp.lanonasis.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mcp.lanonasis.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # CORS for MCP clients
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,X-API-Key' always;

    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # Logging
    access_log /var/log/nginx/mcp-access.log;
    error_log /var/log/nginx/mcp-error.log;

    # SSE (Server-Sent Events) endpoint
    location /sse {
        proxy_pass http://mcp_backend/sse;
        proxy_http_version 1.1;

        # SSE specific headers
        proxy_set_header Connection '';
        proxy_set_header Cache-Control 'no-cache';
        proxy_set_header Content-Type 'text/event-stream';
        proxy_set_header X-Accel-Buffering 'no';

        # Disable buffering for SSE
        proxy_buffering off;
        proxy_cache off;

        # Keep connection alive
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket endpoint for MCP
    location /mcp {
        proxy_pass http://mcp_backend/mcp;
        proxy_http_version 1.1;

        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Keep connection alive
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP API endpoints
    location /v1/ {
        proxy_pass http://mcp_backend/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # Health check
    location /health {
        proxy_pass http://mcp_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # Default MCP route
    location / {
        proxy_pass http://mcp_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Fallback to auth if MCP is down
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_intercept_errors on;
        error_page 502 503 504 = @auth_fallback;
    }

    location @auth_fallback {
        proxy_pass http://auth_backend/mcp/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
