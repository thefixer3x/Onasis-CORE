# 🌐 LanOnasis URL Structure & Endpoint Alignment

**Date:** October 27, 2025  
**Status:** Analysis for VPS Deployment

---

## 📊 Current URL Mapping

### **1. Authentication Services**

| Service | Current URL | Purpose | Status |
|---------|------------|---------|--------|
| **CLI Browser Login** | `https://mcp.lanonasis.com/auth/cli-login` | Browser-based token generation | ✅ Live (Netlify) |
| **Auth Gateway** | `https://auth.lanonasis.com` | Token verification, user management | ⏳ **NEEDS DEPLOYMENT** |
| **Auth Fallback** | `https://api.lanonasis.com/auth/*` | Netlify function fallback | ✅ Live (Netlify) |

### **2. MaaS Services**

| Service | URL | Purpose | Status |
|---------|-----|---------|--------|
| **Memory API** | `https://api.lanonasis.com/api/v1` | Memory CRUD operations | ✅ Live |
| **Landing/Dashboard** | `https://api.lanonasis.com` | Web interface | ✅ Live (Netlify) |
| **Documentation** | `https://docs.lanonasis.com` | API docs | ✅ Live |

### **3. MCP Services**

| Service | URL | Purpose | Status |
|---------|-----|---------|--------|
| **MCP HTTP** | `https://mcp.lanonasis.com/api/v1` | MCP REST API | ✅ Live (VPS) |
| **MCP WebSocket** | `wss://mcp.lanonasis.com/ws` | Real-time MCP | ✅ Live (VPS) |
| **MCP SSE** | `https://mcp.lanonasis.com/api/v1/events` | Server-sent events | ✅ Live (VPS) |
| **MCP Auth Page** | `https://mcp.lanonasis.com/auth/cli-login` | Token generation page | ✅ Live (VPS) |

---

## 🔄 CLI Authentication Flow (Current)

```
User runs: onasis auth login
    ↓
CLI opens: https://mcp.lanonasis.com/auth/cli-login
    ↓
User gets token from page
    ↓
User pastes token into CLI
    ↓
CLI validates token format (rejects URLs)
    ↓
CLI verifies token with server (tries in priority order):
    1. http://localhost:4000/v1/auth/verify-token     [Local Dev]
    2. https://auth.lanonasis.com/v1/auth/verify-token [Auth Gateway] ← ⚠️ NOT DEPLOYED YET
    3. https://api.lanonasis.com/auth/verify           [Netlify Fallback]
    ↓
If verified, CLI stores token in ~/.maas/config.json
    ↓
CLI shows "Authenticated: Yes"
```

---

## ⚠️ Current Issue Identified

### **Problem:**
```bash
onasis auth login  # ✅ Gets token from mcp.lanonasis.com
onasis status      # ❌ Shows "Authenticated: No"
```

### **Root Cause:**
1. CLI tries to verify token at `https://auth.lanonasis.com/v1/auth/verify-token`
2. **Auth gateway is NOT deployed to this URL yet**
3. Falls back to `https://api.lanonasis.com/auth/verify` (Netlify)
4. Token might be validated differently or fail

### **Why It Happens:**
- Token generated by MCP server at `mcp.lanonasis.com` (format: `cli_timestamp_hex`)
- CLI verification expects auth-gateway at `auth.lanonasis.com`
- Auth-gateway has better CLI token validation logic
- Netlify function might not recognize the CLI token format properly

---

## 🎯 Solution: Deploy Auth Gateway

### **Target Deployment**
- **Domain:** `https://auth.lanonasis.com`
- **Server:** VPS (168.231.74.29)
- **Port:** 4000 (internal)
- **Process Manager:** PM2
- **Proxy:** Nginx (port 80/443)

### **Required DNS Setup**
```
auth.lanonasis.com  →  A Record  →  168.231.74.29
```

### **Nginx Configuration Needed**
```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name auth.lanonasis.com;
    
    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/auth.lanonasis.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/auth.lanonasis.com/privkey.pem;
    
    location / {
        proxy_pass http://localhost:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 📋 Auth Gateway Endpoints

Once deployed at `https://auth.lanonasis.com`, these endpoints will be available:

### **Public Endpoints (No Auth Required)**

| Endpoint | Method | Purpose | Used By |
|----------|--------|---------|---------|
| `/health` | GET | Health check | Monitoring |
| `/v1/auth/login` | POST | Password login | Web apps |
| `/v1/auth/verify-token` | POST | Verify token (body) | **CLI** ← Important! |
| `/mcp/auth` | POST | MCP authentication | MCP clients |
| `/admin/bypass-login` | POST | Emergency admin login | Admin tools |

### **Protected Endpoints (Auth Required)**

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/v1/auth/logout` | POST | Logout user |
| `/v1/auth/session` | GET | Get session info |
| `/v1/auth/sessions` | GET | List all sessions |
| `/admin/status` | GET | Admin dashboard |
| `/admin/change-password` | POST | Change admin password |

---

## 🔧 CLI Token Verification Endpoint

### **Current CLI Configuration**

```typescript
// From: apps/lanonasis-maas/cli/src/utils/config.ts

const endpoints = [
  'http://localhost:4000/v1/auth/verify-token',      // Local development
  'https://auth.lanonasis.com/v1/auth/verify-token', // Production auth-gateway ← DEPLOY HERE
  'https://api.lanonasis.com/auth/verify'            // Netlify fallback
];
```

### **Expected Request**
```bash
curl -X POST https://auth.lanonasis.com/v1/auth/verify-token \
  -H "Content-Type: application/json" \
  -d '{"token":"cli_1730009400000_abc123def456"}'
```

### **Expected Response**
```json
{
  "valid": true,
  "type": "cli_token",
  "user": {
    "id": "cli_user",
    "email": "cli@lanonasis.com",
    "role": "authenticated"
  },
  "expires_at": "2025-11-03T07:00:00.000Z"
}
```

---

## 🚀 Deployment Steps for VPS

### **Step 1: DNS Configuration**
```bash
# Add DNS A record (in your domain provider)
auth.lanonasis.com  →  168.231.74.29

# Verify DNS propagation
dig auth.lanonasis.com
nslookup auth.lanonasis.com
```

### **Step 2: VPS Deployment**
```bash
# SSH to VPS
ssh root@168.231.74.29 -p 2222

# Navigate to deployment directory
cd /var/www/onasis-core/services/auth-gateway

# Pull latest code
git pull origin main

# Deploy with PM2
./deploy.sh deploy

# Verify PM2
pm2 status auth-gateway
pm2 logs auth-gateway --lines 20

# Test locally
curl http://localhost:4000/health
```

### **Step 3: Nginx Configuration**
```bash
# Create nginx config
sudo nano /etc/nginx/sites-available/auth-gateway

# Paste the nginx configuration (see above)

# Enable site
sudo ln -sf /etc/nginx/sites-available/auth-gateway /etc/nginx/sites-enabled/

# Test nginx config
sudo nginx -t

# Reload nginx
sudo systemctl reload nginx

# Test externally
curl http://auth.lanonasis.com/health
```

### **Step 4: SSL Certificate (Let's Encrypt)**
```bash
# Install certbot (if not already installed)
sudo apt update
sudo apt install certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d auth.lanonasis.com

# Verify SSL
curl https://auth.lanonasis.com/health

# Auto-renewal is set up automatically
sudo certbot renew --dry-run
```

### **Step 5: Test CLI Integration**
```bash
# On local machine
cd apps/lanonasis-maas/cli

# Logout
./dist/index-simple.js auth logout

# Login (will get token from mcp.lanonasis.com)
./dist/index-simple.js auth login

# Check status (should verify against auth.lanonasis.com)
./dist/index-simple.js status
# Expected: "Authenticated: Yes" ✅
```

---

## 🔍 Testing Checklist

### **Pre-Deployment Tests (Local)**
- [x] PM2 running successfully on localhost:4000
- [x] Health endpoint responding
- [x] CLI token verification working
- [x] Admin bypass login working
- [x] Database connected

### **Post-Deployment Tests (VPS)**
- [ ] DNS resolves to VPS IP
- [ ] Nginx proxying to PM2 correctly
- [ ] SSL certificate valid
- [ ] Health endpoint accessible: `https://auth.lanonasis.com/health`
- [ ] Token verification working: `https://auth.lanonasis.com/v1/auth/verify-token`
- [ ] CLI can authenticate end-to-end
- [ ] Status shows "Authenticated: Yes"
- [ ] Admin login working

---

## 📊 Service Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                        LanOnasis Services                        │
└─────────────────────────────────────────────────────────────────┘

┌────────────────────────┐  ┌────────────────────────┐
│  api.lanonasis.com     │  │  mcp.lanonasis.com     │
│  (Netlify)             │  │  (VPS - Port 3001)     │
├────────────────────────┤  ├────────────────────────┤
│ • Landing Page         │  │ • MCP HTTP API         │
│ • Dashboard            │  │ • MCP WebSocket        │
│ • Memory API           │  │ • MCP SSE              │
│ • Auth Fallback        │  │ • CLI Token Page       │
│ • Docs                 │  │ • Service Discovery    │
└────────────────────────┘  └────────────────────────┘
            │                           │
            └───────────┬───────────────┘
                        ↓
            ┌──────────────────────────┐
            │  auth.lanonasis.com      │
            │  (VPS - Port 4000)       │
            │  ⚠️ NEEDS DEPLOYMENT      │
            ├──────────────────────────┤
            │ • Token Verification     │  ← CLI uses this!
            │ • User Management        │
            │ • Session Tracking       │
            │ • Admin Bypass Login     │
            │ • Neon Database          │
            └──────────────────────────┘
```

---

## 🎯 CLI Endpoint Priority

The CLI tries endpoints in this order for token verification:

1. **Local Development:** `http://localhost:4000/v1/auth/verify-token`
   - For testing during development
   - PM2 running locally

2. **Production Auth Gateway:** `https://auth.lanonasis.com/v1/auth/verify-token`
   - **PRIMARY production endpoint**
   - **⚠️ Currently NOT deployed - this is why auth shows "No"**
   - Should be deployed to VPS at port 4000

3. **Netlify Fallback:** `https://api.lanonasis.com/auth/verify`
   - Backup endpoint
   - May not handle CLI tokens as well
   - Already deployed and working

---

## 🔐 Token Flow Summary

### **Token Generation (Working ✅)**
```
User → mcp.lanonasis.com/auth/cli-login → Token (cli_timestamp_hex)
```

### **Token Verification (Needs Fix ⚠️)**
```
CLI → auth.lanonasis.com/v1/auth/verify-token → NOT DEPLOYED YET
   ↓ (falls back to)
   └→ api.lanonasis.com/auth/verify → May not recognize CLI token format
```

### **After Auth Gateway Deployment (Expected ✅)**
```
CLI → auth.lanonasis.com/v1/auth/verify-token → Valid CLI token recognized
   ↓
Status: "Authenticated: Yes" ✅
```

---

## ✅ Summary & Next Actions

### **Current State**
- ✅ Token generation working (`mcp.lanonasis.com`)
- ✅ MaaS services working (`api.lanonasis.com`)
- ✅ MCP services working (`mcp.lanonasis.com`)
- ⚠️ Token verification failing (auth-gateway not deployed)

### **Issue**
- CLI shows "Authenticated: No" after successful login
- Auth gateway not accessible at `https://auth.lanonasis.com`
- Falls back to Netlify which may not validate CLI tokens properly

### **Solution**
1. Configure DNS: `auth.lanonasis.com → 168.231.74.29`
2. Deploy auth-gateway to VPS using `./deploy.sh deploy`
3. Configure Nginx to proxy `auth.lanonasis.com` to `localhost:4000`
4. Get SSL certificate with Let's Encrypt
5. Test CLI authentication end-to-end

### **Quick Test After Deployment**
```bash
# Should work once deployed
curl https://auth.lanonasis.com/health

# Should validate CLI tokens
curl -X POST https://auth.lanonasis.com/v1/auth/verify-token \
  -H "Content-Type: application/json" \
  -d '{"token":"cli_1730009400000_test"}'

# CLI should show authenticated
onasis status
# Expected: "Authenticated: Yes" ✅
```

---

**Status:** ⚠️ **Misalignment Identified**  
**Cause:** Auth gateway not deployed at `auth.lanonasis.com`  
**Impact:** CLI shows "Authenticated: No" despite valid token  
**Fix:** Deploy auth-gateway to VPS and configure DNS/Nginx  
**Blocked By:** VPS SSH timeout (will deploy when connection restored)
